import React, { useEffect, useRef, useState } from 'react';

const WIDTH = 800;
const HEIGHT = 600;

function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function createEnemy() {
  return {
    x: randomInt(50, WIDTH - 50),
    y: randomInt(50, HEIGHT - 50),
    size: 30,
    speed: 1 + Math.random() * 1.5,
    hp: 3,
  };
}

export default function Home() {
  const canvasRef = useRef(null);
  const [score, setScore] = useState(0);
  const [lives, setLives] = useState(3);

  const player = useRef({
    x: WIDTH / 2,
    y: HEIGHT / 2,
    size: 40,
    speed: 4,
    direction: { x: 0, y: 0 },
    shots: [],
    canShoot: true,
  });

  const enemies = useRef([createEnemy(), createEnemy(), createEnemy()]);
  const keys = useRef({});

  const touchControls = useRef({
    up: false,
    down: false,
    left: false,
    right: false,
    shoot: false,
  });

  useEffect(() => {
    function keyDown(e) {
      keys.current[e.key.toLowerCase()] = true;
    }
    function keyUp(e) {
      keys.current[e.key.toLowerCase()] = false;
    }
    window.addEventListener('keydown', keyDown);
    window.addEventListener('keyup', keyUp);
    return () => {
      window.removeEventListener('keydown', keyDown);
      window.removeEventListener('keyup', keyUp);
    };
  }, []);

  useEffect(() => {
    function shoot() {
      if (!player.current.canShoot) return;
      player.current.canShoot = false;
      const shot = {
        x: player.current.x,
        y: player.current.y,
        size: 8,
        speed: 10,
        direction: { x: 0, y: -1 },
      };
      player.current.shots.push(shot);
      setTimeout(() => {
        player.current.canShoot = true;
      }, 300);
    }

    function onSpace(e) {
      if (e.code === 'Space') {
        shoot();
      }
    }
    window.addEventListener('keydown', onSpace);

    let shootingInterval = null;
    if (touchControls.current.shoot) {
      shoot();
      shootingInterval = setInterval(() => {
        shoot();
      }, 300);
    }

    return () => {
      window.removeEventListener('keydown', onSpace);
      clearInterval(shootingInterval);
    };
  }, [touchControls.current.shoot]);

  useEffect(() => {
    function updateDirection() {
      player.current.direction.x = 0;
      player.current.direction.y = 0;
      if (keys.current['arrowup'] || keys.current['w'] || touchControls.current.up)
        player.current.direction.y = -1;
      if (
        keys.current['arrowdown'] ||
        keys.current['s'] ||
        touchControls.current.down
      )
        player.current.direction.y = 1;
      if (
        keys.current['arrowleft'] ||
        keys.current['a'] ||
        touchControls.current.left
      )
        player.current.direction.x = -1;
      if (
        keys.current['arrowright'] ||
        keys.current['d'] ||
        touchControls.current.right
      )
        player.current.direction.x = 1;
    }

    const interval = setInterval(updateDirection, 30);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    const ctx = canvasRef.current.getContext('2d');

    function update() {
      ctx.clearRect(0, 0, WIDTH, HEIGHT);

      const p = player.current;

      const len = Math.hypot(p.direction.x, p.direction.y);
      if (len > 0) {
        p.x += (p.direction.x / len) * p.speed;
        p.y += (p.direction.y / len) * p.speed;
        p.x = Math.min(Math.max(p.size / 2, p.x), WIDTH - p.size / 2);
        p.y = Math.min(Math.max(p.size / 2, p.y), HEIGHT - p.size / 2);
      }

      ctx.fillStyle = '#007bff';
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2);
      ctx.fill();

      p.shots = p.shots.filter((s) => s.y + s.size > 0);
      p.shots.forEach((s) => {
        s.y -= s.speed;
        ctx.fillStyle = '#ff4500';
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size / 2, 0, Math.PI * 2);
        ctx.fill();
      });

      enemies.current.forEach((enemy, i) => {
        const dx = p.x - enemy.x;
        const dy = p.y - enemy.y;
        const dist = Math.hypot(dx, dy);
        if (dist > 0) {
          enemy.x += (dx / dist) * enemy.speed;
          enemy.y += (dy / dist) * enemy.speed;
        }

        ctx.fillStyle = '#dc3545';
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.size / 2, 0, Math.PI * 2);
        ctx.fill();

        p.shots.forEach((shot, si) => {
          const distShot = Math.hypot(shot.x - enemy.x, shot.y - enemy.y);
          if (distShot < enemy.size / 2 + shot.size / 2) {
            enemy.hp -= 1;
            p.shots.splice(si, 1);
          }
        });

        if (enemy.hp <= 0) {
          enemies.current.splice(i, 1);
          setScore((s) => s + 1);
        }

        if (dist < (enemy.size + p.size) / 2) {
          setLives((l) => l - 1);
          enemy.x = randomInt(50, WIDTH - 50);
          enemy.y = randomInt(50, HEIGHT - 50);
          enemy.hp = 3;
        }
      });

      if (enemies.current.length < 3) {
        enemies.current.push(createEnemy());
      }

      ctx.fillStyle = '#000';
      ctx.font = '20px Arial';
      ctx.fillText(`–û—á–∫–∏: ${score}`, 20, 30);
      ctx.fillText(`–ñ–∏–∑–Ω–∏: ${lives}`, 20, 60);

      if (lives <= 0) {
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(0, 0, WIDTH, HEIGHT);
        ctx.fillStyle = '#fff';
        ctx.font = '50px Arial';
        ctx.fillText('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!', WIDTH / 2 - 150, HEIGHT / 2);
        return;
      }

      requestAnimationFrame(update);
    }

    update();
  }, [score, lives]);

  function touchStartHandler(control) {
    touchControls.current[control] = true;
  }
  function touchEndHandler(control) {
    touchControls.current[control] = false;
  }

  return (
    <>
      <div style={{ textAlign: 'center', marginTop: 20 }}>
        <h1>Top-down –ê—Ä–µ–Ω–∞</h1>
        <canvas
          ref={canvasRef}
          width={WIDTH}
          height={HEIGHT}
          style={{ border: '2px solid #000', backgroundColor: '#eee' }}
        />
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: WASD –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏ + –∫–Ω–æ–ø–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ</p>
        <p>–ù–∞–±–µ—Ä–∏—Ç–µ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –æ—á–∫–æ–≤!</p>
      </div>

      <div
        style={{
          position: 'fixed',
          bottom: 20,
          left: 20,
          display: 'flex',
          flexDirection: 'column',
          gap: 10,
          userSelect: 'none',
          zIndex: 1000,
        }}
      >
        <button
          style={{ width: 60, height: 60, fontSize: 24 }}
          onTouchStart={() => touchStartHandler('up')}
          onTouchEnd={() => touchEndHandler('up')}
          onMouseDown={() => touchStartHandler('up')}
          onMouseUp={() => touchEndHandler('up')}
        >
          ‚Üë
        </button>
        <div style={{ display: 'flex', gap: 10, justifyContent: 'center' }}>
          <button
            style={{ width: 60, height: 60, fontSize: 24 }}
            onTouchStart={() => touchStartHandler('left')}
            onTouchEnd={() => touchEndHandler('left')}
            onMouseDown={() => touchStartHandler('left')}
            onMouseUp={() => touchEndHandler('left')}
          >
            ‚Üê
          </button>
          <button
            style={{ width: 60, height: 60, fontSize: 24 }}
            onTouchStart={() => touchStartHandler('down')}
            onTouchEnd={() => touchEndHandler('down')}
            onMouseDown={() => touchStartHandler('down')}
            onMouseUp={() => touchEndHandler('down')}
          >
            ‚Üì
          </button>
          <button
            style={{ width: 60, height: 60, fontSize: 24 }}
            onTouchStart={() => touchStartHandler('right')}
            onTouchEnd={() => touchEndHandler('right')}
            onMouseDown={() => touchStartHandler('right')}
            onMouseUp={() => touchEndHandler('right')}
          >
            ‚Üí
          </button>
        </div>
      </div>

      <div
        style={{
          position: 'fixed',
          bottom: 20,
          right: 20,
          userSelect: 'none',
          zIndex: 1000,
        }}
      >
        <button
          style={{
            width: 80,
            height: 80,
            borderRadius: '50%',
            fontSize: 24,
            backgroundColor: '#ff4500',
            color: '#fff',
          }}
          onTouchStart={() => touchStartHandler('shoot')}
          onTouchEnd={() => touchEndHandler('shoot')}
          onMouseDown={() => touchStartHandler('shoot')}
          onMouseUp={() => touchEndHandler('shoot')}
        >
          üî´
        </button>
      </div>
    </>
  );
}